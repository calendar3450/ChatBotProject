<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>문서 업로드 테스트</title>
</head>
<body>
<h1>문서 업로드 테스트 페이지</h1>

<hr>

<!-- 1. 문서 생성 폼 (제목만)
<h2>1. 문서 생성</h2>
<form id="create-form">
    <label>
        제목:
        <input type="text" id="title-input" required>
    </label>
    <button type="submit">문서 생성</button>
</form>
<p>
    생성된 문서 ID: <span id="created-id">없음</span>
</p>
<pre id="create-result"></pre>
<hr>
2. 파일 업로드 폼 -->
<!-- <h2>2. PDF 파일 업로드</h2>
<form id="upload-form">
    <label>
        문서 ID:
        <input type="number" id="doc-id-input" required>
    </label>
    <br><br>
    <label>
        PDF 파일:
        <input type="file" id="file-input" accept="application/pdf" required>
    </label>
    <br><br>
    <button type="submit">파일 업로드</button>
</form>
<pre id="upload-result"></pre> -->


<h2>1. 다중 PDF 업로드(원샷)</h2>

<form id="multi-upload-form">
  <label>
    PDF 파일들:
    <input type="file" id="multi-files" accept="application/pdf" multiple required>
  </label>
  <br><br>
  <button type="submit">여러 문서 업로드 + 인덱싱</button>
</form>

<pre id="multi-upload-result"></pre>

<!-- 2. 문서 목록 조회 -->
<h2>2. 문서 목록 조회</h2>
<button id="load-documents-btn">문서 목록 불러오기</button>

<table border="1" style="margin-top: 10px; border-collapse: collapse;">
    <thead>
    <tr>
        <th>ID</th>
        <th>제목</th>
        <th>상태</th>
        <th>파일 경로</th>
        <th>생성일</th>
    </tr>
    </thead>
    <tbody id="documents-tbody">
    <!-- 여기에 JS로 행이 추가됩니다 -->
    </tbody>
</table>

<pre id="documents-raw"></pre>

<hr>

<h2>3. 멀티 문서 챗봇</h2>

<label>
  문서 IDs (콤마로):
  <input type="text" id="chat-doc-ids" placeholder="문서 확인하시고 id 보시고 입력 해주시기 바랍니다 예: 1,2" style="width: 400px;">
</label>
<br><br>

<label>
  질문:
  <input type="text" id="chat-question" style="width: 600px;" placeholder="질문을 입력하세요">
</label>
<button id="chat-send-btn">보내기</button>

<pre id="chat-result"></pre>

<script>
    // Legacy
    // // 1) 문서 생성
    // const createForm = document.getElementById('create-form');
    // const titleInput = document.getElementById('title-input');
    // const createdIdSpan = document.getElementById('created-id');
    // const createResult = document.getElementById('create-result');

    // createForm.addEventListener('submit', async (e) => {
    //     e.preventDefault();

    //     const title = titleInput.value.trim();
    //     if (!title) {
    //         alert('제목을 입력해주세요.');
    //         return;
    //     }

    //     try {
    //         const res = await fetch('/documents', {
    //             method: 'POST',
    //             headers: {
    //                 'Content-Type': 'application/json'
    //             },
    //             body: JSON.stringify({ title })
    //         });

    //         if (!res.ok) {
    //             const text = await res.text();
    //             createResult.textContent = '에러: ' + res.status + '\n' + text;
    //             return;
    //         }

    //         const data = await res.json();
    //         createdIdSpan.textContent = data.id;
    //         createResult.textContent = JSON.stringify(data, null, 2);

    //         // 업로드 폼의 문서 ID 입력칸에도 자동으로 채워주기
    //         document.getElementById('doc-id-input').value = data.id;

    //     } catch (err) {
    //         createResult.textContent = '요청 실패: ' + err;
    //     }
    // });

    // // 2) PDF 파일 업로드
    // const uploadForm = document.getElementById('upload-form');
    // const docIdInput = document.getElementById('doc-id-input');
    // const fileInput = document.getElementById('file-input');
    // const uploadResult = document.getElementById('upload-result');

    // uploadForm.addEventListener('submit', async (e) => {
    //     e.preventDefault();

    //     const docId = docIdInput.value;
    //     const file = fileInput.files[0];

    //     if (!docId) {
    //         alert('문서 ID를 입력하거나 위에서 먼저 문서를 생성해주세요.');
    //         return;
    //     }
    //     if (!file) {
    //         alert('PDF 파일을 선택해주세요.');
    //         return;
    //     }

    //     const formData = new FormData();
    //     formData.append('file', file);

    //     try {
    //         const res = await fetch(`/documents/${docId}/upload`, {
    //             method: 'POST',
    //             body: formData
    //         });

    //         if (!res.ok) {
    //             const text = await res.text();
    //             uploadResult.textContent = '에러: ' + res.status + '\n' + text;
    //             return;
    //         }

    //         const data = await res.json();
    //         uploadResult.textContent = JSON.stringify(data, null, 2);

    //     } catch (err) {
    //         uploadResult.textContent = '요청 실패: ' + err;
    //     }
    // });
    
// const oneshotForm = document.getElementById('oneshot-upload-form');
// const oneshotTitle = document.getElementById('oneshot-title');
// const oneshotFile = document.getElementById('oneshot-file');
// const oneshotDocId = document.getElementById('oneshot-doc-id');
// const oneshotResult = document.getElementById('oneshot-result');

// // (챗봇 섹션이 있다면) docId 자동 채우기
// const chatDocIdInput = document.getElementById('chat-doc-id');

// oneshotForm.addEventListener('submit', async (e) => {
//   e.preventDefault();

//   const title = oneshotTitle.value.trim();
//   const file = oneshotFile.files[0];

//   if (!title) { alert("제목을 입력해주세요."); return; }
//   if (!file) { alert("PDF 파일을 선택해주세요."); return; }

//   oneshotResult.textContent = "업로드 중... (Python ingest까지 호출합니다)";

//   const formData = new FormData();
//   formData.append("title", title);
//   formData.append("file", file);

//   try {
//     const res = await fetch("/documents/upload", {
//       method: "POST",
//       body: formData
//     });

//     if (!res.ok) {
//       const text = await res.text();
//       oneshotResult.textContent = "에러: " + res.status + "\n" + text;
//       return;
//     }

//     const data = await res.json();
//     oneshotResult.textContent = JSON.stringify(data, null, 2);

//     oneshotDocId.textContent = data.id;

//     // 챗봇 docId 자동 입력
//     if (chatDocIdInput) {
//       chatDocIdInput.value = data.id;
//     }

//   } catch (err) {
//     oneshotResult.textContent = "요청 실패: " + err;
//   }
// });

// 1) 문서 생성 pdf 문서 여러개 적용.
const multiForm = document.getElementById('multi-upload-form');
const multiFiles = document.getElementById('multi-files');
const multiResult = document.getElementById('multi-upload-result');

multiForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const files = multiFiles.files;
  if (!files || files.length === 0) {
    alert("PDF 파일을 선택해주세요.");
    return;
  }

  const formData = new FormData();
  for (const f of files) {
    formData.append("files", f); // 같은 key로 여러 번 append하면 List로 받습니다
  }

  multiResult.textContent = "업로드/인덱싱 중...";

  try {
    const res = await fetch("/documents/uploads", {
      method: "POST",
      body: formData
    });

    if (!res.ok) {
      const text = await res.text();
      multiResult.textContent = "에러: " + res.status + "\n" + text;
      return;
    }

    const data = await res.json(); // List<DocumentResponse>
    multiResult.textContent = "업로드가 완료되었습니다.\n"

  } catch (err) {
    multiResult.textContent = "요청 실패: " + err;
  }
  
});

     // 2) 문서 목록 조회
    const loadBtn = document.getElementById('load-documents-btn');
    const docsTbody = document.getElementById('documents-tbody');
    const docsRaw = document.getElementById('documents-raw');

    loadBtn.addEventListener('click', async () => {
        try {
            const res = await fetch('/documents', { method: 'GET' });

            if (!res.ok) {
                const text = await res.text();
                docsRaw.textContent = '에러: ' + res.status + '\n' + text;
                return;
            }

            const data = await res.json();

            // 테이블 비우고 다시 채우기
            docsTbody.innerHTML = '';

            data.forEach(doc => {
                const tr = document.createElement('tr');

                const tdId = document.createElement('td');
                tdId.textContent = doc.id;

                const tdTitle = document.createElement('td');
                tdTitle.textContent = doc.title;

                const tdStatus = document.createElement('td');
                tdStatus.textContent = doc.status;

                const tdPath = document.createElement('td');
                tdPath.textContent = doc.filePath || '(없음)';

                const tdCreatedAt = document.createElement('td');
                tdCreatedAt.textContent = doc.createAt || '';

                tr.appendChild(tdId);
                tr.appendChild(tdTitle);
                tr.appendChild(tdStatus);
                tr.appendChild(tdPath);
                tr.appendChild(tdCreatedAt);

                docsTbody.appendChild(tr);
            });

        } catch (err) {
            docsRaw.textContent = '요청 실패: ' + err;
        }
    });

//3. 챗봇 기능 구현
const chatDocIdsInput = document.getElementById('chat-doc-ids');
const chatQuestionInput = document.getElementById('chat-question');
const chatSendBtn = document.getElementById('chat-send-btn');
const chatResult = document.getElementById('chat-result');

chatSendBtn.addEventListener('click', async () => {
  const raw = chatDocIdsInput.value.trim();
  const question = chatQuestionInput.value.trim();

  if (!raw) { alert("문서 ID를 입력해주세요."); return; }
  if (!question) { alert("질문을 입력해주세요."); return; }

  const documentIds = raw.split(',')
    .map(s => Number(s.trim()))
    .filter(n => Number.isFinite(n) && n > 0);

  if (documentIds.length === 0 && documentIds != 0) {
    alert("문서 ID 형식이 잘못됐습니다. 예: 261,262");
    return;
  }

  chatResult.textContent = "답변 생성 중...";

  const res = await fetch('/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      documentIds,
      question,
      topK: 5
    })
  });

  if (!res.ok) {
    chatResult.textContent = '에러: ' + res.status + '\n' + await res.text();
    return;
  }

  chatResult.textContent = JSON.stringify(await res.json(), null, 2);
});
    
</script>

</body>
</html>
